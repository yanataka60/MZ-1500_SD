# MZ-1500にSD-CARDからのアプリケーション起動、ロード、セーブ機能

![MZ-1500_SD](https://github.com/yanataka60/MZ-1500_SD/blob/main/JPEG/TITLE.jpg)

　MZ-1500でSD-CARDからのアプリケーション起動、BASICなどのアプリケーションからSD-CARDへのロード、セーブを実現するものです。

　MZ-1500にはMZ-1R12が装備されているとS-RAMに保存されているプログラムから起動する機能がありますが、疑似的にMZ-1R12のふりをすることでMZ-1500_SDに搭載したROMからSD-CARDからアプリケーションを起動させる機能を持たせたMONITORプログラムを起動させます。

　SD対応MONITORからはFD又はFDLコマンドでSDからアプリケーションをLOAD実行ができます。

　SD対応MONITORは本体ROMの1Z-009BをRAMにコピーしてうえでSD対応のプログラムを付加しています。

　MZ-80K用のアプリケーションは

　LOAD実行範囲は、0000h～CFFFhです。アプリケーション、ゲームを起動させるにはほぼ問題ないと思います。

　なお、アプリケーション中でのSD-CARDとのロード、セーブについては、アプリケーションごとにSD-CARD対応化を行う必要があります。

　現在、アプリケーション中でのSD-CARDとのLOAD、SAVEに対応できているものは以下のとおりです。

|アプリケーション名|備考|
| ------------ | ------------ |
|MZ-700用SBasic 1Z-007B||
|ROPOKO v1.2.2||
|ROPOKO80K v1.1.2||

　なお、Arduino、ROMへ書き込むための機器が別途必要となります。

## 回路図
　KiCadフォルダ内のMZ-1500_SD.pdfを参照してください。

[回路図](https://github.com/yanataka60/MZ-1500_SD/blob/main/KiCad/MZ-1500_SD.pdf)

![MZ-1500_SD](https://github.com/yanataka60/MZ-1500_SD/blob/main/KiCad/MZ-1500_SD.jpg)

|番号|品名|数量|備考|
| ------------ | ------------ | ------------ | ------------ |
||J2、J3のいずれか|||
|J2|Micro_SD_Card_Kit|1|秋月電子通商 AE-microSD-LLCNV (注1)|
|J3|MicroSD Card Adapter|1|Arduino等に使われる5V電源に対応したもの(注3)|
|U1,U2|74LS04|2||
|U3,U4|74LS30|2||
|U5|74LS10|1||
|U6|74LS14|1||
|U7|8255|1||
|U8|Arduino_Pro_Mini_5V|1|Atmega328版を使用 168版は不可。(注2)|
|U9-U12|74LS193|4||
|U13|27256/29C256/27512/27C512相当品|1|27256/29C256を使うときは、S1を5V側にして使うこと。28C256はピン配置が違うので使えません。|
|U14|74LS245|1||
|C1,C2,C4-C14|積層セラミックコンデンサ 0.1uF|13||
|C3|電解コンデンサ 16v100uF|1||
|C15|積層セラミックコンデンサ 220pF|1||
|R1|カーボン抵抗 100Ω|1||
|S1|3Pスライドスイッチ|1|秋月電子通商 SS12D01G4など|
||ピンヘッダ|2Pin分|Arduino_Pro_MiniにはA4、A5用のピンヘッダが付いていないため別途調達が必要です 秋月電子通商 PH-1x40SGなど|
||ピンソケット(任意)|26Pin分|Arduino_Pro_Miniを取り外し可能としたい場合に調達します 秋月電子通商 FHU-1x42SGなど|

　　　注1)秋月電子通商　AE-microSD-LLCNVのJ1ジャンパはショートしてください。

　　　注2)Arduino Pro MiniはA4、A5ピンも使っています。

　　　注3)MicroSD Card Adapterを使う場合

　　　　　J3に取り付けます。

MicroSD Card Adapterについているピンヘッダを除去してハンダ付けするのが一番確実ですが、J3の穴にMicroSD Card Adapterをぴったりと押しつけ、裏から多めにハンダを流し込むことでハンダ付けをする方法もあります。なお、この方法の時にはしっかりハンダ付けが出来たかテスターで導通を確認しておいた方が安心です。

ハンダ付けに自信のない方はJ2の秋月電子通商　AE-microSD-LLCNVをお使いください。AE-microSD-LLCNVならパワーLED、アクセスLEDが付いています。

![MicroSD Card Adapter1](https://github.com/yanataka60/MZ-1500_SD/blob/main/JPEG/MicroSD%20Card%20Adapter.JPG)

## ROMへの書込み
　Z80フォルダの「1Z-009B_Launcher」フォルダ内の1Z-009B_SD_Launcher.binをROMライター(TL866II Plus等)を使って27C256に書き込んでください。

　27C512を使えば二つのバイナリファイルを切り替えて使うような使い方ができます。このとき、一つのバイナリファイルは32KByte、二つ合わせて64KByteにして書き込んでください。

　もうひとつのLauncherとして「Oh!MZ別冊 ADVANCED MZ-700」に掲載されたMZ-80K/CコンパチモニタFN-700をベースとしたFN-700_1500SD_Launcherを作成しました。

### FN-700_1500SD_Launcher.bin作成手順
　1)「Oh!MZ別冊 ADVANCED MZ-700」掲載のMZ-80K/CコンパチモニタFN-700のMZTファイルを用意します。

　2)MZTファイルのヘッダ128Byte分は不要ですのでバイナリエディタで削除します。

　3)先頭の16Byteも不要ですので削除し、C3 4A 00から始まる4096Byteのファイルとします。

　4)以下のアドレスを修正します。

|ADDRESS|修正前|修正後|
| ------------ | ------------ | ------------ |
|0179|F0|C1|
|0437|D5 C5 E5|C3 04 C1|
|0476|D5 C5 E5|C3 07 C1|
|04D9|D5 C5 E5|C3 0A C1|
|04F9|D5 C5 E5|C3 0D C1|
|0589|D5 C5 E5|C3 10 C1|

　5)Z80フォルダの「FN-700_Launcher」フォルダ内のFN-700_1500SD.binを先程加工したFN-700の後ろに連結します。6430Byteのファイルになります。

　6)先頭に9Byteのヘッダ「00 00 00 12 00 22 00 00 00」を付加します。6439Byteのファイルになります。FN-700_1500SD_DATA.binなど適当なファイル名を付けて保存します。

　7)Z80フォルダの「FN-700_Launcher」フォルダ内の1Z-1R12_Header.exeを実行し、先程作成したFN-700_1500SD_DATA.binをドラッグ＆ドロップします。

　8)1Z-1R12_Header.exeを起動したフォルダにチェックサムを正しく計算したMZ1500SD.ROMが作成されます。6574Byteのファイルになっているはずです。

　9)MZ1500SD.ROM(FN-700_1500SD_Launcher.bin)をROMライター(TL866II Plus等)を使ってROMに書き込んでください。

## Arduinoプログラム

　MZ-80K_SDと全く同じものを使用しています。

https://github.com/yanataka60/MZ80K_SD/tree/main/Arduino/MZ-80K_SD

　MZ-80K_SDでソケットを使用して差込式にしているのであればそのままMZ-2000_SDに差して使えます。

　Arduino IDEを使ってMZ-80Kリポジトリ Arduinoフォルダ内のMZ-80K_SD.inoを書き込みます。

　SdFatライブラリを使用しているのでArduino IDEメニューのライブラリの管理からライブラリマネージャを立ち上げて「SdFat」をインストールしてください。

　「SdFat」で検索すれば見つかります。「SdFat」と「SdFat - Adafruit Fork」が見つかりますが「SdFat」のほうを使っています。

注)Arduinoを基板に直付けしている場合、Arduinoプログラムを書き込むときは、MZ-15000本体とは接続を外し、74LS04を外したうえで書き込んでください。

## 接続
　拡張スロットに差し込んで使います。

　なお、拡張スロットから引き抜くときに引き抜きやすいよう基板両サイドと中央に穴を開けてあります。

　穴にドライバー等を引っ掛けて押し出すようにすれば引き抜きやすいと思います。

![CONNECT](https://github.com/yanataka60/MZ-1500_SD/blob/main/JPEG/DSC_4723.JPG)

## SD-CARD
　出来れば8GB以下のSDカードを用意してください。

　ArduinoのSdFatライブラリは、SD規格(最大2GB)、SDHC規格(2GB～32GB)に対応していますが、SDXC規格(32GB～2TB)には対応していません。

　また、SDHC規格のSDカードであっても32GB、16GBは相性により動作しないものがあるようです。

　FAT16又はFAT32が認識できます。NTFSは認識できません。

　ルートに置かれたMZTファイルのみ認識できます。(MZT以外のファイル、フォルダも表示されますがLOAD実行の対象になりません)

　ファイル名は「.MZT」を除いて32文字まで、ただし半角カタカナ、及び一部の記号はArduinoが認識しないので使えません。パソコンでファイル名を付けるときはアルファベット、数字および空白でファイル名をつけてください。

## 操作方法
　ROM起動させた場合にMONITORコマンド入力待ちから以下のコマンドが拡張されます。

　以下、SD-CARD内のファイルに付けられるファイル名をDOSファイル名、MZT形式ファイルのインフォメーションブロック内ファイル名をIBFファイル名とします。

### FD[CR]
　FDのみでDOSファイル名「0000.MZT」がLOAD及び実行されます。

　「0000.MZT」は、パソコンでBASIC等をリネームコピーして作成してください。

　LOAD実行可能範囲は0000h～CFFFhです。

### FD　DOSファイル名[CR]
　DOSファイル名で指定したバイナリファイルをLOADして実行します。

　「.MZT」は省略可能です。

　LOAD実行可能範囲は0000h～CFFFhです。

例)

FD　TEST[CR]

### FDL[CR]
　SD-CARDルートディレクトリにあるファイルの一覧を表示します。20件表示したところで指示待ちになるので打ち切るならSHIFT+BREAK又は↑を入力すると打ち切られ、Bキーで前の20件に戻ります。それ以外のキーで次の20件を表示します。

　行頭に「*FD」を付加して表示してあるので実行したいファイルにカーソルキーを合わせて[CR]キーを押すだけでLOAD、実行が可能です。

　表示される順番は、登録順となりファイル名アルファベッド順などのソートした順で表示することはできません。

　LOAD実行可能範囲は0000h～CFFFhです。

### FDL　x[CR]
ファイル名がxで始まるファイルの一覧を表示します。20件表示したところで指示待ちになるので打ち切るならSHIFT+BREAK又は↑を入力すると打ち切られ、Bキーで前の20件に戻ります。それ以外のキーで次の20件を表示します。

xはMZのキーボードから入力可能な32文字までの文字列です。(数字、記号、アルファベット)

　LOAD実行可能範囲は0000h～CFFFhです。


例)

FDL S[CR]

FDL SP[CR]

FDL BASIC S[CR]


### アプリケーションからのLOAD


### アプリケーションからのSAVE

## アプリケーションからSD-CARDとのLOAD、SAVEをするための対応
### BASIC

## MZ-700版ロポコのMZ-1500_SD対応パッチ
　ロポコ for MZ-80KはMZ-80K_SDにも対応していますが、元祖MZ-700版ロポコはMZ-80K_SDに対応していません。

　この度、作者のTookato様がロポコVersion 1.2.2をリリースされましたが、このアーカイブには無圧縮版のロポコが同梱されており、パッチを当てることでMZ-80K_SD対応とすることが出来ましたので公開します。

### 使い方
　ロポコVersion 1.2.2を入手します。

　解凍すると「Uncompressed」フォルダにROPOKO-PR.MZT、ROPOKO-AR.MZT、ROPOKO-BR.MZT、の三つのファイルがあるのでSDカードにコピーします。

　このGitHubのMZ80K_SDリポジトリ中の「ROPOKO」フォルダ内の「ROPOKO-SD.MZT」をSDカードにコピーします。

　FDL又はFDコマンドを使ってSDカードにコピーした「ROPOKO-SD.MZT」を実行します。

　ROPOKO-PR.MZTを自動的に読込み、SD対応のパッチを当て、ロポコが起動します。

　シナリオの読込は、例えばシナリオAを選択し、「テープをセットしてください」と表示された後にCRを一回押すと「DOS FILE:」と表示されるので「ROPOKO-AR」と正しく入力し、CRを押すことで読み込みが始まります。

　データのセーブ・ロードはF3キーを押し、S:Save L:Loadを選択するとファイル名の入力になります。A面では「SA-」B面では「SB-」で始まるファイル名とし「SA-1/2/3...」のように異なる名前を付けるところはオリジナルと同様です。

　ただし、セーブ時に既にあるファイル名を指定すると上書きしますのでお気を付けください。

## 謝辞
　基板の作成に当たり以下のデータを使わせていただきました。ありがとうございました。

　Arduino Pro Mini

　　https://github.com/g200kg/kicad-lib-arduino

　AE-microSD-LLCNV

　　https://github.com/kuninet/PC-8001-SD-8kRAM

